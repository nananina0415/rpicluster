#!/bin/bash

# μ¤ν¬λ¦½νΈ μ‹¤ν–‰ κ¶ν• ν™•μΈ
if [ "$EUID" -ne 0 ]; then
  echo "π¨ κ²½κ³ : μ΄ μ¤ν¬λ¦½νΈλ” root μ‚¬μ©μλ΅ μ‹¤ν–‰ν•΄μ•Ό ν•©λ‹λ‹¤."
  exit 1
fi

# μ¤ν¬λ¦½νΈκ°€ μ„μΉν• λ””λ ‰ν† λ¦¬λ΅ μ΄λ™ν•μ—¬ κ²½λ΅ λ¬Έμ λ¥Ό λ°©μ§€ν•©λ‹λ‹¤.
cd "$(dirname "$0")" || exit

echo "ν΄λ¬μ¤ν„° μ „μ²΄ μ„¤μ •μ„ μ‹μ‘ν•©λ‹λ‹¤."
echo "------------------------------------"

# 1λ‹¨κ³„: Ansible μ‹¤ν–‰μ„ μ„ν• μµμ† ν¨ν‚¤μ§€ μ„¤μΉ
echo "Ansible μ‹¤ν–‰μ— ν•„μ”ν• ν¨ν‚¤μ§€(python3, ansible)λ¥Ό μ„¤μΉν•©λ‹λ‹¤..."
apk update
apk add --no-cache python3 openssh-client ansible

echo "β”  ν•„μ ν¨ν‚¤μ§€ μ„¤μΉ μ™„λ£."
echo ""

# 2λ‹¨κ³„: Ansible ν”λ μ΄λ¶ μ‹¤ν–‰
echo "'setup.yml' ν”λ μ΄λ¶μ„ μ‹¤ν–‰ν•μ—¬ μ „μ²΄ ν΄λ¬μ¤ν„°λ¥Ό κµ¬μ„±ν•©λ‹λ‹¤."
ansible-playbook setup.yml # μΈλ²¤ν† λ¦¬ νμΌ(-i) μ—†μ΄ λ°”λ΅ ν”λ μ΄λ¶μ„ μ‹¤ν–‰

# ν”λ μ΄λ¶ μ‹¤ν–‰ μ„±κ³µ μ—¬λ¶€ ν™•μΈ
if [ $? -ne 0 ]; then
  echo "β Ansible ν”λ μ΄λ¶ μ‹¤ν–‰ μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤. λ΅κ·Έλ¥Ό ν™•μΈν•΄μ£Όμ„Έμ”."
  exit 1
fi